# 抢购脚本使用说明

## 功能概述

这是一个专为微信小程序抢购设计的Android自动化脚本系统。系统采用**无障碍服务 + JS注入 + 网络监控**的技术方案，能够智能识别小程序的API接口并自动执行抢购操作。

### 核心特性

1. **智能API监控**：自动拦截和分析小程序的网络请求
2. **库存检查**：实时监控商品库存状态
3. **自动抢购**：发现库存时自动执行购买操作
4. **悬浮窗控制**：提供便捷的脚本控制界面
5. **高频操作**：支持每500ms一次的高频检查
6. **接口重放**：直接通过API进行抢购，速度更快

## 技术架构

### 核心模块

1. **AutoBuyAccessibilityService**：无障碍服务，用于控制微信应用
2. **NetworkMonitor**：网络监控器，拦截和分析API请求
3. **FloatingWindowService**：悬浮窗服务，提供操作界面
4. **ScriptActivity**：主控制界面，管理权限和脚本状态

### 工作原理

```
微信小程序 → JS注入 → API拦截 → 库存分析 → 自动抢购
     ↓           ↓        ↓        ↓        ↓
  页面操作 → 网络请求 → 数据捕获 → 状态判断 → 接口重放
```

## 使用步骤

### 1. 权限配置

#### 无障碍服务权限
1. 打开应用，进入"抢购脚本"界面
2. 点击"开启"无障碍服务按钮
3. 在系统设置中找到"VPNSelf"应用
4. 开启无障碍服务权限

#### 悬浮窗权限
1. 点击"开启"悬浮窗权限按钮
2. 在系统设置中允许应用显示悬浮窗

### 2. 脚本启动

1. 确保两个权限都已开启（界面显示为绿色"已启用"）
2. 打开微信小程序的抢购页面
3. 回到脚本应用，点击"开始抢购"
4. 系统会自动启动悬浮窗和监控服务

### 3. 操作流程

1. **初始化阶段**：
   - 脚本注入JS代码到小程序页面
   - 开始监控网络请求
   - 悬浮窗显示在屏幕上

2. **学习阶段**：
   - 手动点击"按个买"按钮
   - 脚本自动捕获相关API接口
   - 分析库存查询和购买接口

3. **自动阶段**：
   - 脚本每500ms检查一次库存
   - 发现库存时自动执行购买
   - 支持API重放和UI操作两种模式

## 高级功能

### API监控与重放

系统会自动识别以下类型的接口：

- **库存查询接口**：包含stock、inventory、available等关键词
- **购买接口**：包含buy、purchase、order等关键词
- **用户认证**：自动提取token和cookie信息

### 智能抢购策略

1. **优先级策略**：
   - 首选：直接API重放（速度最快）
   - 备选：UI自动化操作

2. **循环逻辑**：
   ```
   按个买 → 检查购买按钮状态 → 有库存则购买
      ↓                            ↓
   按箱买 → 重新触发库存查询 ← 无库存则刷新
   ```

3. **容错机制**：
   - 网络错误自动重试
   - UI元素查找失败的降级处理

### 悬浮窗功能

- **最小化/最大化**：支持窗口大小切换
- **实时状态**：显示脚本运行状态和API数量
- **快速控制**：一键启动/停止脚本

## 安全性说明

### 数据处理
- 所有网络请求数据仅在本地处理
- 不会向外部服务器发送任何信息
- 用户token和cookie仅用于接口重放

### 权限使用
- 无障碍服务仅监控微信应用
- 悬浮窗权限仅用于显示控制界面
- 不会访问其他应用的数据

## 故障排除

### 常见问题

1. **脚本无法启动**
   - 检查无障碍服务是否正确开启
   - 确认悬浮窗权限已授予
   - 重启应用重新授权

2. **无法捕获API**
   - 确保在小程序页面内操作
   - 手动点击几次按钮让脚本学习
   - 检查JavaScript注入是否成功

3. **抢购不成功**
   - 确认捕获到了购买接口
   - 检查用户登录状态
   - 验证商品是否真的有库存

4. **系统卡死或卡顿（重要）** ⚠️
   - **立即关闭无障碍服务**：设置 → 辅助功能 → VPNSelf → 关闭
   - **重启应用**：完全退出应用后重新打开
   - **检查设备性能**：建议在性能较好的设备上使用
   - **降低使用频率**：不要长时间连续运行脚本
   
   **性能优化措施**：
   - 事件节流：500ms内只处理一次无障碍事件
   - 内存限制：最多保存50个API请求记录
   - 数据截断：限制请求和响应数据大小
   - 协程管理：使用局部作用域避免内存泄漏

### 调试信息

可以通过以下方式查看调试信息：
- 应用内API监控界面
- Android logcat日志（标签：AutoBuyService、NetworkMonitor）
- 悬浮窗的API计数显示

## 技术限制

1. **平台限制**：仅支持Android系统
2. **应用限制**：主要针对微信小程序
3. **网络限制**：需要稳定的网络连接
4. **权限限制**：需要用户主动授予系统权限

## 免责声明

此脚本仅供技术研究和学习使用，使用者需要：
1. 遵守相关法律法规
2. 尊重商家和平台的规则
3. 承担使用风险和后果
4. 不得用于商业牟利

## 更新日志

### v1.0.0
- 实现基础的无障碍服务功能
- 支持JS注入和API监控
- 提供悬浮窗控制界面
- 实现自动抢购逻辑

---

**注意**：使用前请仔细阅读所有说明，确保理解系统的工作原理和限制。如有问题请参考故障排除部分或查看源代码。 